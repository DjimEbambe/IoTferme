<%
  const normalizeKey = (value) => {
    if (value === undefined || value === null) return '';
    return value
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, '');
  };
  const canonicalLookup = {
    BLDGA: 'BLDG:A',
    BATIMENT1: 'BLDG:A',
    BAT1: 'BLDG:A',
    BATIMENTA: 'BLDG:A',
    BLDGB: 'BLDG:B',
    BATIMENT2: 'BLDG:B',
    BAT2: 'BLDG:B',
    BATIMENTB: 'BLDG:B',
    SUPPROV: 'SUP:PROV',
    COUVEUSE: 'SUP:PROV',
  };
  const friendlyLabels = {
    'BLDG:A': 'Bâtiment 1',
    'BLDG:B': 'Bâtiment 2',
    'SUP:PROV': 'Couveuse',
  };
  const canonicalId = (value) => canonicalLookup[normalizeKey(value)] || null;
  const relevantAssets = (twin.assets || []).reduce((list, asset) => {
    const canonical = canonicalId(asset.asset_id) || canonicalId(asset?.metadata?.display_name) || canonicalId(asset?.label);
    if (!canonical || !friendlyLabels[canonical] || list.find((item) => item.canonical === canonical)) return list;
    list.push({ canonical, friendly: friendlyLabels[canonical] });
    return list;
  }, []);
%>

<div class="section-heading">
  <div>
    <div class="title">IotFarm — Jumeau numérique</div>
    <div class="subtitle">Suivi en direct de Bâtiment 1, Bâtiment 2 et Couveuse</div>
  </div>
  <button class="btn-soft" id="btnToggleHeatmap" data-mode="temperature">
    <i class="bi bi-thermometer-half me-2"></i>Température
  </button>
</div>

<section class="twin-layout">
  <div>
    <div class="scene-container shadow-soft">
      <canvas id="twinCanvas" aria-label="Vue 3D du site de production"></canvas>
      <div class="scene-overlay">
        <p class="mb-1 fw-semibold">Navigation rapide</p>
        <ul class="overlay-list mb-0">
          <li><strong>Souris</strong> : pivoter autour des bâtiments</li>
          <li><strong>Molette</strong> : zoom avant / arrière</li>
          <li><strong>Maj + Souris</strong> : glisser latéralement</li>
          <li>
            <button class="btn btn-sm btn-outline-light" data-focus-asset="BLDG:A">Bâtiment 1</button>
            <button class="btn btn-sm btn-outline-light" data-focus-asset="BLDG:B">Bâtiment 2</button>
            <button class="btn btn-sm btn-outline-light" data-focus-asset="SUP:PROV">Couveuse</button>
          </li>
        </ul>
        <div class="live-summary" id="liveSummary">
          <p class="text-secondary mb-0">Données en cours de synchronisation...</p>
        </div>
      </div>
    </div>
  </div>

  <aside class="twin-sidebar">
    <div class="panel shadow-soft">
      <h5 class="panel-title">Valeurs en temps réel</h5>
      <p class="panel-subtitle">Les mesures sont actualisées automatiquement à chaque cycle de ventilation.</p>
      <div id="liveMetrics" class="metric-grid"></div>
    </div>

    <div class="panel shadow-soft">
      <h5 class="panel-title">Commandes rapides</h5>
      <form id="comfortControls" class="form-grid">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="mb-3">
          <label class="form-label" for="controlAsset">Zone à commander</label>
          <select class="form-select" id="controlAsset" name="asset_id" required>
            <% relevantAssets.forEach((asset) => { %>
              <option value="<%= asset.canonical %>"><%= asset.friendly %></option>
            <% }) %>
          </select>
        </div>

        <fieldset class="mb-3">
          <legend class="form-label">Action</legend>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="action" id="actLightsOn" value="lights_on" checked>
            <label class="btn btn-outline-light" for="actLightsOn">Éclairage ON</label>
            <input type="radio" class="btn-check" name="action" id="actLightsOff" value="lights_off">
            <label class="btn btn-outline-light" for="actLightsOff">Éclairage OFF</label>
          </div>
          <div class="btn-group w-100 mt-2" role="group">
            <input type="radio" class="btn-check" name="action" id="actVentOn" value="ventilation_on">
            <label class="btn btn-outline-light" for="actVentOn">Ventilation ON</label>
            <input type="radio" class="btn-check" name="action" id="actVentOff" value="ventilation_off">
            <label class="btn btn-outline-light" for="actVentOff">Ventilation OFF</label>
          </div>
          <div class="btn-group w-100 mt-2" role="group">
            <input type="radio" class="btn-check" name="action" id="actDoorsOpen" value="doors_open">
            <label class="btn btn-outline-light" for="actDoorsOpen">Ouvrir les portes</label>
            <input type="radio" class="btn-check" name="action" id="actDoorsClose" value="doors_close">
            <label class="btn btn-outline-light" for="actDoorsClose">Fermer les portes</label>
          </div>
        </fieldset>

        <button class="btn btn-success" type="submit"><i class="bi bi-send-fill me-2"></i>Envoyer</button>
      </form>
    </div>
  </aside>
</section>

<script nonce="<%= nonce %>">
window.__TWIN__ = {
  csrfToken: '<%= csrfToken %>',
  twin: <%- JSON.stringify(twin || {}) %>,
  modelRoot: '<%= modelRoot %>'
};
</script>

<div class="section-heading">
  <div>
    <div class="title">Jumeau numérique</div>
    <div class="subtitle">Visualisation immersive du site, commandes et calibration en direct</div>
  </div>
  <div class="scene-toolbar">
    <button class="btn-soft" id="btnToggleHeatmap" data-mode="temperature"><i class="bi bi-thermometer-half me-2"></i>Heatmap Température</button>
    <button class="btn-soft" id="btnToggleLayout"><i class="bi bi-palette me-2"></i>Mode layout</button>
    <button class="btn-soft" id="btnLayoutSave"><i class="bi bi-save me-2"></i>Sauvegarder</button>
  </div>
</div>

<section class="twin-layout">
  <div>
    <div class="scene-container shadow-soft">
      <canvas id="twinCanvas"></canvas>
      <div class="position-absolute top-0 end-0 m-3 p-3 rounded-4" style="background: rgba(0,0,0,0.45);">
        <div class="d-flex align-items-center gap-2 text-secondary">
          <i class="bi bi-geo-alt"></i>
          <span>Site: <strong>SITE:KIN-GOLIATH</strong></span>
        </div>
        <div class="d-flex align-items-center gap-2 text-secondary mt-1">
          <i class="bi bi-buildings"></i>
          <span>Bâtiments: 2 • PP: 16 • Zones: 5</span>
        </div>
      </div>
    </div>

    <div class="panel shadow-soft mt-4">
      <div class="panel-header">
        <div>
          <h5 class="fw-semibold mb-0">Anomalies capteurs</h5>
          <small class="text-secondary">Offsets dynamiques, calibrations, validation terrain</small>
        </div>
      </div>
      <div class="control-card">
        <form id="calibrationForm" class="row g-3">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-md-4">
            <label class="form-label">PP</label>
            <select class="form-select" name="pp_id" id="calibrationPPSelect">
              <% (twin.assets || []).filter(a => a.type === 'pp').forEach((asset) => { %>
              <option value="<%= asset.asset_id %>"><%= asset.asset_id %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Offset température (°C)</label>
            <input type="number" step="0.1" name="offset_temp" class="form-control" placeholder="0.2">
          </div>
          <div class="col-md-4">
            <label class="form-label">Offset hygrométrie (%)</label>
            <input type="number" step="0.1" name="offset_hygro" class="form-control" placeholder="-1.5">
          </div>
          <div class="col-12 text-end">
            <button type="button" class="btn btn-outline-light btn-sm" id="btnCalibrate"><i class="bi bi-tools me-1"></i>Appliquer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <aside class="d-flex flex-column gap-3">
    <div class="control-card shadow-soft">
      <h6>Chaleur & hygrométrie</h6>
      <div id="heatmapPanel" class="scrollable-y">
        <p class="text-secondary">En attente de données...</p>
      </div>
    </div>

    <div class="control-card shadow-soft">
      <h6>Commandes équipements</h6>
      <form id="formCmd" class="d-grid gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div>
          <label class="form-label">Asset</label>
          <input class="form-control" name="asset_id" placeholder="BLDG:A-PP-01" required>
        </div>
        <div>
          <label class="form-label">Action</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="action" id="cmdLampOn" value="lamp_on" checked>
            <label class="btn btn-outline-light" for="cmdLampOn"><i class="bi bi-brightness-high me-1"></i>Lampes ON</label>
            <input type="radio" class="btn-check" name="action" id="cmdLampOff" value="lamp_off">
            <label class="btn btn-outline-light" for="cmdLampOff">Lampes OFF</label>
          </div>
          <div class="btn-group w-100 mt-2" role="group">
            <input type="radio" class="btn-check" name="action" id="cmdFan" value="fan_on">
            <label class="btn btn-outline-light" for="cmdFan"><i class="bi bi-fan me-1"></i>Ventilation</label>
            <input type="radio" class="btn-check" name="action" id="cmdDoor" value="door_open">
            <label class="btn btn-outline-light" for="cmdDoor"><i class="bi bi-door-open me-1"></i>Porte</label>
          </div>
        </div>
        <button class="btn btn-success" type="submit"><i class="bi bi-send-fill me-1"></i>Exécuter</button>
      </form>
    </div>

    <div class="control-card shadow-soft">
      <h6>Assets</h6>
      <ul class="control-list scrollable-y" id="assetList">
        <% (twin.assets || []).forEach((asset) => { %>
        <li data-asset-id="<%= asset.asset_id %>">
          <span><i class="bi bi-box-seam me-1 text-secondary"></i><%= asset.asset_id %></span>
          <button class="btn btn-sm btn-outline-light" data-focus-asset="<%= asset.asset_id %>">Focus</button>
        </li>
        <% }) %>
        <% if (!(twin.assets || []).length) { %>
        <li class="text-secondary">Aucun asset modélisé pour l'instant.</li>
        <% } %>
      </ul>
    </div>
  </aside>
</section>

<script nonce="<%= nonce %>">
window.__TWIN__ = {
  csrfToken: '<%= csrfToken %>',
  twin: <%- JSON.stringify(twin || {}) %>
};
</script>
